# --- Stage 1: Builder ---
# This stage installs dependencies, including build-time tools.
FROM python:3.9-slim AS builder

# Set the working directory
WORKDIR /app

# Install build dependencies
RUN apt-get update && \
    apt-get install -y gcc build-essential

# Copy requirements file and install packages
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install pytest pytest-asyncio

COPY . .


# --- Stage 2: Final Image ---
# This stage creates the final, clean image.
FROM python:3.9-slim

# Set the working directory
WORKDIR /app

# Copy the installed packages from the 'builder' stage.
# This avoids needing build tools in the final image.
COPY --from=builder /usr/local/lib/python3.9/site-packages /usr/local/lib/python3.9/site-packages

# Copy the application code from the 'builder' stage
COPY --from=builder /app .

# Set the command to run the tests
CMD ["python", "-m", "pytest", "-v", "tests/"]